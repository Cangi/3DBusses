<html>
<head>
<script src="https://cdn-webgl.wrld3d.com/wrldjs/dist/latest/wrld.js"></script>
<script src="busRoutes.js"></script>
<script src="busStopList.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css" rel="stylesheet" />
<link rel="stylesheet" href="testcss.css">

</head>
<body>

	<div style="position: relative">
		<div id="map" style="height: 100%"></div>		
			<script>
			let routes = {};

			//create map 
			var map = L.Wrld.map("map", "c976700dbe05df6d18bdab38af2b1ae2", {center: [56.458522, -2.97107], zoom: 15});
						
			// create custom icon
    		var BusStop = L.Icon.extend({
    		options: {
        		iconSize:     [75, 75],
        		iconAnchor:   [32.5, 75],
        		popupAnchor:  [-3, -76]
    			}
			});

			//links to images used for stops
			var linkBusStop = 'https://cdn.iconscout.com/icon/premium/png-512-thumb/bus-stop-10-660162.png'
			var linkBusStation = 'https://cdn2.iconfinder.com/data/icons/large-home-icons/512/Bus_station_transportation_space.png'
			var stop1 = new BusStop({iconUrl: linkBusStop});
			var stopBusStation = new BusStop({iconUrl: linkBusStation});
    
    		L.icon = function (options) {
    			return new L.Icon(options);
			};
			
			var stopsArray = []
			var stationsArray = []
			
			//Open schedule when a bus stop/station is clicked
			function newWindow(value) {
			
				var myWindow;
    			var width = 400;
    			var height = 300;
    			var left = parseInt((screen.availWidth/2) - (width/2));
    			var top = parseInt((screen.availHeight/2) - (height/2));
    			var windowFeatures = "width=" + width + ",height=" + height + ",status,resizable,left=" + left + ",top=" + top + ",location = no";
    			
				
				myWindow = window.open("", "mywindow", windowFeatures);
				setTimeout(function(){
				myWindow.document.title = 'Bus schdule' ;
				}, 10);//open() and title() is asynchronous
				
				var txt = "schedule";
				myWindow.document.write("<center>" + txt.fontsize(6) + "</center>");
				
				if (value < 100) { // Distinguish better a bus stop and a bus station
				
					myWindow.document.write ("Bus stop nº: " + locations[value][2] + "<br></br>");
					myWindow.document.write ("This is route " + locations[value][3] + "<br></br>");
					myWindow.document.write ("Bus stop name: " + locations[value][4]);
				}
				else {
					value = value - 1000 // Get the real value again
					myWindow.document.write ("Bus Station nº: " + locationBusStations[value][2] + "<br></br>");
					myWindow.document.write ("This is in route " + locationBusStations[value][3] + "<br></br>");
					myWindow.document.write ("Station name: " + locations[value][4]);
					
				}
				
			}
			//Add bus stops
			for (i = 0; i < locations.length; i++) {  
				var x = i
				var stops = L.marker([locations[i][0], locations[i][1]], {icon: stop1}).on('click', L.bind(newWindow, null, x));
				console.log(x)
				stopsArray[i] = stops
		
      		};
      		
      		//Add bus stations
      		for (i = 0; i < locationBusStations.length; i++) {  
				var z = 1000 + i // Distinguish better a bus stop and a bus station
        		var stations = L.marker([locationBusStations[i][0], locationBusStations[i][1]], {icon: stopBusStation}).on('click', L.bind(newWindow, null, z));
        		stationsArray[i] = stations
        		
      		};
      		
      		//Hide  bus stops markers when zoomed out
      		var stopMarkers = new L.FeatureGroup();
      		
      		for (i = 0; i < locations.length; i++) {
      		
      			stopMarkers.addLayer(stopsArray[i]);
			}
			   
      		 // Add markers the first time the page is loaded
      		map.addLayer(stopMarkers);
      		map.on('zoomend', function() {
    			if (map.getZoom() < 14){
            		map.removeLayer(stopMarkers);
    				}
    				else {
            		map.addLayer(stopMarkers);
        			}
			});
			
			//Hide  bus stations markers when zoomed out
			var stationMarkers = new L.FeatureGroup();
      		
      		for (i = 0; i < locationBusStations.length; i++) {
      		
      			stationMarkers.addLayer(stationsArray[i]);
      		}
			   
			// Add markers the first time the page is loaded
      		map.addLayer(stationMarkers);
      		map.on('zoomend', function() {
    			if (map.getZoom() < 14){
            		map.removeLayer(stationMarkers);
    				}
    				else {
            		map.addLayer(stationMarkers);
        			}
			});
			
			//create a feature group for routes
			var routeFeatureGroup = new L.FeatureGroup();
			//add all routes to map via layer
      		map.addLayer(routeFeatureGroup);
			//on zoomout varible <13, remove from map
      		map.on('zoomend', function() {
    			if (map.getZoom() < 13){
            		map.removeLayer(routeFeatureGroup);
    				}
    				else {
            		map.addLayer(routeFeatureGroup);
        			}
			});
      			
			//function which creates a route for a specific bus X
			function getRoute(x)
			{
				var busNumber = x;
				$.get({
					url: "/getBusStops",
					data : {busNumber : x},
					success : function(json) {
						routes[x] = json[0].route;				
						//create the polyline
						var bus = L.polyline(routes[x], {color: getRandomColor(), className: 'BusOptions'});
						//add this route to the route group
						routeFeatureGroup.addLayer(bus);
						//event handler for onclick event
						function OnBusClick() {
							alert("This is route : " + x);
						}
						bus.on('click', L.bind(OnBusClick, null, x));
						
						//on mouseover bring the route to front
						bus.on('mouseover', function(e) {
							e.target.bringToFront();
						});
						
					}
				})
			}
			
			//creates each route
			var numberOneBus = getRoute(1);
			var numberFourBus = getRoute(4);
			var numberFiveBus = getRoute(5);
			var numberTwentyThreeSBus = getRoute(23);
			var numberThirtyTwoBus = getRoute(32);
			var numberThirtyTwoBus = getRoute(75);
			
			//BEWARE - if routes > colors then new routes will be black
			var colors = ['ef0b0b','ef670b','1bc415','26e2c0','9c73dd','ff1c63', '291A6D', '3B552E', '922C2C', '82244D', 'B62222', '2B781F', '85B87D', 'E9E43D', 'DD832F', '9F7676', '1D2FB2', 'efd809', '00705d', '004570', '310449', 'b7005b'];
			function getRandomColor() {
				// hexadecimal starting symbol
				var hashtag = '#'; 
                //Set your colors here
                if (colors.length > 0){
					var chosenIndex = Math.floor(Math.random() * colors.length);
					var color = hashtag += colors[chosenIndex];
					colors.splice(chosenIndex, 1);
				}else{
					var color = '#000000'
				}
				return color;
			}
			
			</script>		
		</div>
	</div>
</body>
</html>